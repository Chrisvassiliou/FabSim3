matrix:
  include:
    - stage: testing
      language: python
      python:
        - "3.6"
      install:
        - pip install -r requirements.txt
        - sed "s/your-username/`whoami`/g" <<< cat deploy/machines_user_example.yml > deploy/machines_user.yml
        - rm -f ~/.ssh/id_rsa
        - ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
        - cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
        - chmod og-wx ~/.ssh/authorized_keys
        - ssh-keyscan -H localhost >> ~/.ssh/known_hosts
        - fab localhost install_plugin:FabDummy
      script:
        - python -m pytest tests/
        - py.test --pep8 base/

    - stage: building docker image
      sudo: required
      services:
      - docker
      env:
        - secure: "M23rL5Ch9CPOdNTwimEMa+a8JEoaZB5f9j2CgR8FdOSJ+n2fPxHSH3qiQ2siWUeDoVDlBHnPGc9E7BuHTVjip/XsZhVudWio4rbXZvi9dW/rs5aQL9mm5uNio5w4vtYuVlmOpOn6M0a6PuYJVcUd9z5oZda3P66xX0991hb0i1BdWiMZQtKy+HjKJq7u0bCITO/5CoPPHgYQbr7O0QdmZ7jy61dbItkr/FQipNj7NI83+ihPc9YC805rUzMEl8/xGUFYMyj79Re0leJsSlX8UM4TDVpTpYn79Nip1HoR0aOhDC9O7nbDOC8osHwfGG3Z5BMC6iojjWUep4syOdKtIjGC1RqpY1Zk47pVMNBIuam6NRkVwVwDv5U0VSxSBocMf9KaG084eBTmKt9ZRKz8Mic25BM1EINCq+Vufaeo1shfdY/PTRnQv+omBbCZ4U0DkJsx0FVUyy5Fhw0yBLYKBNhzb4tuZFmAhfBuwkjpiUVXAus6c3jAboPrYdSUck9lLmmoPooznjXX36m3WMsFlUcPtTQguqw1BDdtip48JmqH5Gcbcv9SQPsv3u1erDaDH7xRFCUr93F8ySI9tXGXstwDpPtnPDXYwAPyQ5U9g1wpU42gzWKD/G2bddJmQ9rulDw7qs3DLi6sX9nAil6qfz77Vyd4adRiLK+PDwQvHa8="

        - secure: "HQk7tKJzjTS0hznpZRc6CCUzTN1RhoQF6bVtCg+XCC7rxkLws7tQr0Ac708SWNRUuIAGflXdB7ZjWIkSQN6lpQwtMkIdlCnG7fxIdqqy40c75n/WiP5jKwJxa72yWMWjaOGsQPga2a640C+NI1fUp061fOr9lSA5zod64IemgZI4vq2jI7F+W/PbWAu4ObXZWMT7bjLfS3uxuaKpC0Cic5V+319CcVBFf12qXwQggVG7JxPcAI2X6xmPc1y4GsfasQDV2zb6sDZg3sNMWCXqoFCckSLtya4tZm8fYeFm+v0QJw8mV7G293rsYDdl1Oe7cyAzHCJ4K1+U2I24dSthRDsR1eKZ3mdfkJspqQxjFCMN/PA3SZ9J2GECeMNSTM881e12o2fTsmnOw512OFeJGiaRuw9QIdK7770pGZ4Kv20U5lT/i29uveAJBvWzeFf5JY9mR4xkyj82j49WVQfzk6P35NLw+R80tFMDFvZ24Q3clF7WB/CdxD72mvTQ/BNWNqE80t3SiQh5/Mapeq0+av4mymZ4Uw6x5Rn9C2JDEWoJFSrX72VozPPD6Us1hFosANwuoPkr1k9oGVDYGNSKSV7ptvPlGMDPFC+gc1N+rkQGVa/KbECGlO17EG45OXJKd1znHnKsAJ4gQ//71s4+oY0PAu6/gJ6YaxGuajR/CxQ="

      before_script:
      - docker pull vecmafabsim3/fabsimdocker || true
      script:
      - docker build --pull --cache-from vecmafabsim3/fabsimdocker --tag vecmafabsim3/fabsimdocker .
      #- docker build --pull --tag vecmafabsim3/fabsimdocker .
      - docker run vecmafabsim3/fabsimdocker
      after_script:
      - docker images
      before_deploy:
      - docker login -u $DOCKER_USER -p $DOCKER_PASS
      deploy:
        provider: script
        script: docker push vecmafabsim3/fabsimdocker
        on:
          branch: master
